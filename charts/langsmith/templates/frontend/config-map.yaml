apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "langsmith.fullname" . }}-{{ .Values.frontend.name }}
  namespace: {{ .Values.namespace | default .Release.Namespace }}
  labels:
    {{- include "langsmith.labels" . | nindent 4 }}
  annotations:
    {{- include "langsmith.annotations" . | nindent 4 }}
data:
{{- if .Values.config.basePath }}
  nginx.conf: |
    proxy_ssl_server_name on;

    proxy_cache_path /tmp/server_cache levels=1:2 keys_zone=llm_cache:100m max_size=1g inactive=60 use_temp_path=off;

    log_format cache_log_json escape=json
    '{'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"time_local":"$time_local",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"cache_status":"$upstream_cache_status"'
    '}';

    {{- if .Values.frontend.ssl.enabled }}
    # HTTP server for health checks only
    server {
        listen       {{ .Values.frontend.containerPort }};
        {{- if .Values.frontend.ipv6Enabled }}
        listen  [::]:{{ .Values.frontend.containerPort }};
        {{- end }}
        server_name  localhost;

        # Only allow health checks on HTTP
        location = /health {
            access_log off;
            return 200;
        }

        # Redirect everything else to HTTPS
        location / {
            return 301 https://$host:{{ .Values.frontend.ssl.port }}$request_uri;
        }
    }
   {{- end }}

    server {
        {{- if .Values.frontend.ssl.enabled }}
        listen       {{ .Values.frontend.ssl.port }} ssl;
        {{- if .Values.frontend.ipv6Enabled }}
        listen  [::]:{{ .Values.frontend.ssl.port }} ssl;
        {{- end }}

        ssl_certificate     {{ .Values.frontend.ssl.certificatePath }};
        ssl_certificate_key {{ .Values.frontend.ssl.keyPath }};

        {{- else }}
        listen       {{ .Values.frontend.containerPort }};
        {{- if .Values.frontend.ipv6Enabled }}
        listen  [::]:{{ .Values.frontend.containerPort }};
        {{- end }}
        {{- end }}

        server_name  localhost;
        client_max_body_size {{ .Values.frontend.maxBodySize }};
        proxy_read_timeout {{ .Values.frontend.proxyReadTimeout }};
        proxy_connect_timeout {{ .Values.frontend.proxyConnectTimeout }};
        proxy_send_timeout {{ .Values.frontend.proxyWriteTimeout }};
        keepalive_timeout {{ .Values.frontend.keepAliveTimeout }};

        add_header Content-Security-Policy "{{ .Values.frontend.cspHeader }}" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        access_log /var/log/nginx/access.log cache_log_json;

        location = /health {
                # health checks are frequent and boring, so we avoid logging them
                access_log off;
                return 200;
         }

        location = /nginx_status {
            stub_status on;
            access_log off;
        }

        location /{{ .Values.config.basePath }}/api/v1/playground/ {
            rewrite /{{ .Values.config.basePath }}/api/v1/playground/(.*) /playground/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.playground.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.playground.service.port }};
        }

        # Platform Backend Routes
        location /{{ .Values.config.basePath }}/api/v1/platform/ {
            rewrite /{{ .Values.config.basePath }}/api/v1/platform/(.*) /v1/platform/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /{{ .Values.config.basePath }}/api/v1/oauth/ {
            rewrite /{{ .Values.config.basePath }}/api/v1/oauth/(.*) /oauth/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /{{ .Values.config.basePath }}/api/v1/otel/ {
            rewrite /{{ .Values.config.basePath }}/api/v1/otel/(.*) /otel/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/v1/runs/multipart {
            rewrite /{{ .Values.config.basePath }}/api/v1/runs/multipart /runs/multipart  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/v1/runs/batch {
            rewrite /{{ .Values.config.basePath }}/api/v1/runs/batch /runs/batch  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/v1/runs {
            rewrite /{{ .Values.config.basePath }}/api/v1/runs /runs  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/v1/info {
            rewrite /{{ .Values.config.basePath }}/api/v1/info /info  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/v1/me {
            rewrite /{{ .Values.config.basePath }}/api/v1/me /me  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/v1/metadata/submit {
            rewrite /{{ .Values.config.basePath }}/api/v1/metadata/submit /v1/metadata/submit break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /{{ .Values.config.basePath }}/api/v1/auth {
            rewrite /{{ .Values.config.basePath }}/api/v1/(.*) /$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /{{ .Values.config.basePath }}/scim {
            rewrite /{{ .Values.config.basePath }}/scim/(.*) /scim/$1 break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/v1/public/download {
            rewrite /{{ .Values.config.basePath }}/api/v1/public/(.*) /public/$1 break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /{{ .Values.config.basePath }}/api/public {
            rewrite /{{ .Values.config.basePath }}/api/public/(.*) /public/$1 break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /{{ .Values.config.basePath }}/api/commits {
            rewrite /{{ .Values.config.basePath }}/api/commits/(.*) /commits/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /{{ .Values.config.basePath }}/api/v1/commits {
            rewrite /{{ .Values.config.basePath }}/api/v1/commits/(.*) /commits/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        # Backend Routes
        location /{{ .Values.config.basePath }}/api/v1 {
            rewrite /{{ .Values.config.basePath }}/api/v1/(.*) /api/v1/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

    {{- if .Values.config.deployment.enabled }}
        location /{{ .Values.config.basePath }}/api-host {
            rewrite /{{ .Values.config.basePath }}/api-host/(.*) /$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.hostBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.hostBackend.service.port }};
        }
    {{- end }}

    {{- if and .Values.agentBuilder.enabled .Values.agentBuilder.toolServer.enabled }}
        location /{{ .Values.config.basePath }}/mcp {
            rewrite /{{ .Values.config.basePath }}/mcp/(.*) /$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.agentBuilder.toolServer.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.agentBuilder.toolServer.service.port }};
        }
    {{- end }}

    {{- if and .Values.agentBuilder.enabled .Values.agentBuilder.triggerServer.enabled }}
        location /{{ .Values.config.basePath }}/triggers {
            rewrite /{{ .Values.config.basePath }}/triggers/(.*) /v1/triggers/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.agentBuilder.triggerServer.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.agentBuilder.triggerServer.service.port }};
        }
    {{- end }}

        location = /{{ .Values.config.basePath }}/api/runs/multipart {
            rewrite /{{ .Values.config.basePath }}/api/runs/multipart /runs/multipart  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/runs/batch {
            rewrite /{{ .Values.config.basePath }}/api/runs/batch /runs/batch  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/runs {
            rewrite /{{ .Values.config.basePath }}/api/runs /runs  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/info {
            rewrite /{{ .Values.config.basePath }}/api/info /info  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/me {
            rewrite /{{ .Values.config.basePath }}/api/me /me  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        # Deprecated Backend Routes
        location /{{ .Values.config.basePath }}/api {
            rewrite /{{ .Values.config.basePath }}/api/(.*) /api/v1/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/docs {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/redoc {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api/openapi.json {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

    {{- if .Values.config.deployment.enabled }}
        location = /{{ .Values.config.basePath }}/api-host/docs {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.hostBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.hostBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api-host/redoc {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.hostBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.hostBackend.service.port }};
        }

        location = /{{ .Values.config.basePath }}/api-host/openapi.json {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.hostBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.hostBackend.service.port }};
        }
    {{- end }}

        location = /{{ .Values.config.basePath }} {
            absolute_redirect off;
            rewrite ^ /{{ .Values.config.basePath }}/ permanent;
        }

        location /{{ .Values.config.basePath }} {
            root   /tmp;
            index  index.html index.htm;
            try_files $uri $uri/ /{{ .Values.config.basePath }}/index.html;
        }
    }
{{- else }}
  nginx.conf: |
    proxy_ssl_server_name on;

    proxy_cache_path /tmp/server_cache levels=1:2 keys_zone=llm_cache:100m max_size=1g inactive=60 use_temp_path=off;

    log_format cache_log_json escape=json
    '{'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"time_local":"$time_local",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"cache_status":"$upstream_cache_status"'
    '}';

    {{- if .Values.frontend.ssl.enabled }}
    # HTTP server for health checks only
    server {
        listen       {{ .Values.frontend.containerPort }};
        {{- if .Values.frontend.ipv6Enabled }}
        listen  [::]:{{ .Values.frontend.containerPort }};
        {{- end }}
        server_name  localhost;

        # Only allow health checks on HTTP
        location = /health {
            access_log off;
            return 200;
        }

        # Redirect everything else to HTTPS
        location / {
            return 301 https://$host:{{ .Values.frontend.ssl.port }}$request_uri;
        }
    }
   {{- end }}

    server {
        {{- if .Values.frontend.ssl.enabled }}
        listen       {{ .Values.frontend.ssl.port }} ssl;
        {{- if .Values.frontend.ipv6Enabled }}
        listen  [::]:{{ .Values.frontend.ssl.port }} ssl;
        {{- end }}

        ssl_certificate     {{ .Values.frontend.ssl.certificatePath }};
        ssl_certificate_key {{ .Values.frontend.ssl.keyPath }};

        {{- else }}
        listen       {{ .Values.frontend.containerPort }};
        {{- if .Values.frontend.ipv6Enabled }}
        listen  [::]:{{ .Values.frontend.containerPort }};
        {{- end }}
        {{- end }}

        server_name  localhost;
        client_max_body_size {{ .Values.frontend.maxBodySize }};
        proxy_read_timeout {{ .Values.frontend.proxyReadTimeout }};
        proxy_connect_timeout {{ .Values.frontend.proxyConnectTimeout }};
        proxy_send_timeout {{ .Values.frontend.proxyWriteTimeout }};
        keepalive_timeout {{ .Values.frontend.keepAliveTimeout }};

        add_header Content-Security-Policy "{{ .Values.frontend.cspHeader }}" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        access_log /var/log/nginx/access.log cache_log_json;

        {{- if .Values.frontend.includeNonce }}
        location / {
            sub_filter_once off;
            # Replace placeholder with nonce in HTML
            sub_filter '%%NONCE%%' $request_id;

            root   /tmp/build;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
        {{- else }}
        location / {
            root   /tmp/build;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
        {{- end }}

        location = /health {
                  # health checks are frequent and boring, so we avoid logging them
                  access_log off;
                  return 200;
        }

        location = /nginx_status {
            stub_status on;
            access_log off;
        }

        location /api/v1/playground/ {
            rewrite /api/v1/playground/(.*) /playground/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.playground.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.playground.service.port }};
        }

        # Platform Backend Routes
        location /api/v1/platform/ {
            rewrite /api/v1/platform/(.*) /v1/platform/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /api/v1/oauth/ {
            rewrite /api/v1/oauth/(.*) /oauth/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /api/v1/otel/ {
            rewrite /api/v1/otel/(.*) /otel/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
         }

        location = /api/v1/runs/multipart {
            rewrite /api/v1/runs/multipart /runs/multipart  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /api/v1/runs/batch {
            rewrite /api/v1/runs/batch /runs/batch  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /api/v1/runs {
            rewrite /api/v1/runs /runs  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /api/v1/info {
            rewrite /api/v1/info /info  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
         }

        location = /api/v1/me {
            rewrite /api/v1/me /me  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
         }

        location = /api/v1/metadata/submit {
            rewrite /api/v1/metadata/submit /v1/metadata/submit  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
         }

         location /api/v1/auth {
            rewrite /api/v1/(.*) /$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
         }

        location /api/public {
            rewrite /api/public/(.*) /public/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /api/v1/public/download {
            rewrite /api/v1/public/(.*) /public/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /scim/ {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /api/commits {
            rewrite /api/commits/(.*) /commits/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location /api/v1/commits {
            rewrite /api/v1/commits/(.*) /commits/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        # Backend Routes
        location /api/v1 {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

    {{- if .Values.config.deployment.enabled }}
        location /api-host {
            rewrite /api-host/(.*) /$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.hostBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.hostBackend.service.port }};
        }
    {{- end }}

        location = /api/runs/multipart {
            rewrite /api/runs/multipart /runs/multipart  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /api/runs/batch {
            rewrite /api/runs/batch /runs/batch  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /api/runs {
            rewrite /api/runs /runs  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /api/info {
            rewrite /api/info /info  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        location = /api/me {
            rewrite /api/me /me  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.platformBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.platformBackend.service.port }};
        }

        # Deprecated Backend Routes To be removed in v8
        location /api {
            rewrite /api/(.*) /api/v1/$1  break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
       }

        location = /api/docs {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

        location = /api/redoc {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

        location = /api/openapi.json {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.backend.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.backend.service.port }};
        }

    {{- if .Values.config.deployment.enabled }}
        location = /api-host/docs {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.hostBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.hostBackend.service.port }};
        }

        location = /api-host/redoc {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.hostBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.hostBackend.service.port }};
        }

        location = /api-host/openapi.json {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.hostBackend.name }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.hostBackend.service.port }};
        }
    {{- end }}

    {{- if and .Values.agentBuilder.enabled .Values.agentBuilder.toolServer.enabled }}
        location /mcp {
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.agentBuilder.toolServer.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.agentBuilder.toolServer.service.port }};
        }
    {{- end }}

    {{- if and .Values.agentBuilder.enabled .Values.agentBuilder.triggerServer.enabled }}
        location /triggers {
            rewrite ^/triggers(.*)$ $1 break;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_pass http://{{ include "langsmith.fullname" . }}-{{ .Values.agentBuilder.triggerServer.name }}.{{ .Values.namespace | default .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.agentBuilder.triggerServer.service.port }};
        }
    {{- end }}
      }
{{- end }}
