{{- /*
================================================================================
CONFIGURATION VALIDATION
================================================================================

This template validates configuration and prevents deployment when:
1. Deprecated values are detected
2. Invalid or conflicting configuration is present
3. Required values are missing or malformed

This template intentionally does not render any Kubernetes resources.
It only performs validation checks and fails template rendering if issues are found.
================================================================================
*/}}

{{- /* Validate ingress configuration */ -}}
# Fail if none of ingress, gateway, or istioGateway are enabled and LangSmith Deployment is enabled
{{- if and (not .Values.ingress.enabled) (not .Values.gateway.enabled) (not .Values.istioGateway.enabled) .Values.config.deployment.enabled }}
{{- fail "Either ingress, gateway, or istioGateway must be enabled if LangGraph Platform is enabled." -}}
{{- end -}}

# Fail if hostname is missing when deployment is enabled
{{- if and .Values.config.deployment.enabled (not .Values.config.hostname) }}
{{- fail "config.hostname is required when LangGraph Platform deployment is enabled." -}}
{{- end -}}

# Fail if rootDomain is missing when deployment is enabled
{{- if .Values.config.deployment.rootDomain }}
{{- fail "config.rootDomain is deprecated. Please use config.hostname" -}}
{{- end -}}

# Fail if more than one ingress type is enabled
{{- $enabledCount := 0 -}}
{{- if .Values.ingress.enabled }}{{ $enabledCount = add1 $enabledCount }}{{- end -}}
{{- if .Values.gateway.enabled }}{{ $enabledCount = add1 $enabledCount }}{{- end -}}
{{- if .Values.istioGateway.enabled }}{{ $enabledCount = add1 $enabledCount }}{{- end -}}
{{- if gt $enabledCount 1 -}}
{{- fail "Only one of ingress, gateway, or istioGateway can be enabled at the same time." -}}
{{- end -}}
{{- /* Validate authentication configuration */ -}}
{{- if and .Values.config.basicAuth.enabled .Values.config.oauth.enabled -}}
{{- fail "Basic auth and OAuth are both enabled. Please enable only one." -}}
{{- end -}}

{{- /* Validate langsmithLicenseKey and apikeysalt are set */ -}}
{{- if not .Values.config.existingSecretName -}}
{{- if not .Values.config.apiKeySalt -}}
{{- fail "config.apiKeySalt is required. This may have previously been set to your license key by default. Set this value to the license key to avoid invalidating existing API Keys. This can alternatively be set within .Values.config.existingSecretName." -}}
{{- end -}}
{{- if not .Values.config.langsmithLicenseKey -}}
{{- fail "config.langsmithLicenseKey is required.  This can alternatively be set within .Values.config.existingSecretName." -}}
{{- end -}}
{{- end -}}

{{- if and (not .Values.config.basicAuth.enabled) (not .Values.config.oauth.enabled) -}}
{{- fail "Neither Basic auth nor OAuth are enabled. Please enable one of them." -}}
{{- end -}}
{{- if and (ne .Values.config.authType "mixed") (ne .Values.config.authType "oauth") -}}
{{- fail "config.authType must be either 'mixed' or 'oauth'." -}}
{{- end -}}
{{- if and (.Values.config.basicAuth.enabled) (ne .Values.config.authType "mixed") -}}
{{- fail "Basic auth is enabled but config.authType is not set to 'mixed'." -}}
{{- end -}}

{{- /* Validate initial org admin email */ -}}
{{- if or .Values.config.basicAuth.enabled -}}
{{- if not (or .Values.config.initialOrgAdminEmail .Values.config.basicAuth.initialOrgAdminEmail) -}}
{{- fail "initialOrgAdminEmail is required if basic auth is enabled. Please set config.initialOrgAdminEmail." -}}
{{- end -}}
{{- end -}}

{{- /* Validate custom cert */ -}}
{{- if .Values.config.customCa.secretName -}}
{{- if not .Values.config.customCa.secretKey -}}
{{- fail "config.customCa.secretKey is required when config.customCa.secretName is set." -}}
{{- end -}}
{{- end -}}

{{- /* Validate redis cluster configuration */ -}}
{{- if .Values.redis.external.cluster.enabled -}}
{{- if not .Values.redis.external.enabled -}}
{{- fail "redis.external.enabled must be true when redis.external.cluster.enabled is true." -}}
{{- end -}}
{{- end -}}

{{- /* Validate password requirements */ -}}
{{- if and .Values.config.basicAuth.enabled (not .Values.config.existingSecretName) }}
{{- $password := .Values.config.basicAuth.initialOrgAdminPassword -}}
{{- if lt (len $password) 12 -}}
{{- fail "Admin password must be at least 12 characters long" -}}
{{- end -}}
{{- if not (regexMatch "[a-z]" $password) -}}
{{- fail "Admin password must contain at least one lowercase letter" -}}
{{- end -}}
{{- if not (regexMatch "[A-Z]" $password) -}}
{{- fail "Admin password must contain at least one uppercase letter" -}}
{{- end -}}
{{- if not (regexMatch `[!#$%()+,./:?@\[\]\\^_{~}-]` $password) -}}
{{- fail "Admin password must contain at least one symbol from: !#$%()+,-./:?@[\\]^_{~}" -}}
{{- end -}}
{{- end }}

{{- /* Validate operator/listener configuration */ -}}
{{- $hasListenerTemplates := and (hasKey .Values "listener") (hasKey .Values.listener "templates") (not (empty .Values.listener.templates)) -}}
{{- if $hasListenerTemplates -}}
{{- fail "templates have moved to the operator. Please move your values from .Values.listener.templates to .Values.operator.templates." -}}
{{- end -}}

{{- /* Validate breaking changes from v12+ */ -}}
{{- if hasKey .Values.config "langgraphPlatform" }}
{{- fail "As of v12, config.langgraphPlatform has been moved to config.deployment. Please update your values.yaml file." }}
{{- end }}

{{- if hasKey .Values.config.deployment "langgraphPlatformLicenseKey" }}
{{- fail "As of v12, langgraphPlatform no longer needs a dedicated license key. You can remove this value." }}
{{- end }}

{{- if hasKey .Values.config "subdomain" }}
{{- fail "As of v12, istioGateway.subdomain has been moved to istioGateway.basePath. Please update your values.yaml file." }}
{{- end }}

{{- if hasKey .Values.ingress "hostname" }}
{{- fail "As of v12, ingress.hostname has been moved to config.hostname. Please update your values.yaml file." }}
{{- end }}

{{- if hasKey .Values.ingress "subdomain" }}
{{- fail "As of v12, ingress.subdomain has been moved to config.basePath. Please update your values.yaml file." }}
{{- end }}

{{- if hasKey .Values.gateway "hostname" }}
{{- fail "As of v12, gateway.hostname has been moved to config.hostname. Please update your values.yaml file." }}
{{- end }}

{{- if hasKey .Values.gateway "subdomain" }}
{{- fail "As of v12, gateway.subdomain has been moved to config.basePath. Please update your values.yaml file." }}
{{- end }}

{{- if hasKey .Values.istioGateway "hostname" }}
{{- fail "As of v12, istioGateway.hostname has been moved to config.hostname. Please update your values.yaml file." }}
{{- end }}

{{- if hasKey .Values.istioGateway "subdomain" }}
{{- fail "As of v12, istioGateway.subdomain has been moved to config.basePath. Please update your values.yaml file." }}
{{- end }}

{{- if and .Values.config.observability.tracing.enabled (not .Values.config.observability.tracing.endpoint) -}}
{{- fail "When tracing is enabled (config.observability.tracing.enabled=true), config.observability.tracing.endpoint must be provided" -}}
{{- end -}}

{{- if and .Values.config.blobStorage.enabled (not .Values.config.blobStorage.engine) -}}
{{- fail "When blob storage is enabled (config.blobStorage.enabled=true), config.blobStorage.engine must be one of [S3, Azure]" -}}
{{- end -}}

{{- if and .Values.config.blobStorage.enabled (not (or (eq .Values.config.blobStorage.engine "S3") (eq .Values.config.blobStorage.engine "s3") (eq .Values.config.blobStorage.engine "Azure") (eq .Values.config.blobStorage.engine "azure"))) -}}
{{- fail "When blob storage is enabled (config.blobStorage.enabled=true), config.blobStorage.engine must be one of [S3, Azure]" -}}
{{- end -}}

{{- /* Validate postgres mTLS configuration */ -}}
{{- if and .Values.postgres.external.clientCert.secretName (not .Values.postgres.external.customTls) -}}
{{- fail "postgres.external.customTls must be true when postgres.external.clientCert.secretName is set." -}}
{{- end -}}

{{- /* Validate clickhouse mTLS configuration */ -}}
{{- if and .Values.clickhouse.external.clientCert.secretName (not .Values.clickhouse.external.existingSecretName) (not .Values.clickhouse.external.tls) -}}
{{- fail "clickhouse.external.tls must be true when clickhouse.external.clientCert.secretName is set and the value is not being fetched from an existing secret." -}}
{{- end -}}

{{- /* Validate agent builder configuration */ -}}
{{- if .Values.config.agentBuilder.enabled -}}
{{- if and (not .Values.config.agentBuilder.encryptionKey) (not .Values.config.existingSecretName) -}}
{{- fail "config.agentBuilder.encryptionKey is required when Agent Builder is enabled. Generate one with: python -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\"" -}}
{{- end -}}
{{- if not .Values.config.deployment.enabled -}}
{{- fail "config.deployment.enabled must be true when agentBuilder is enabled. Agent Builder requires LangSmith Deployments." -}}
{{- end -}}
{{- end -}}

{{- /* Validate insights configuration */ -}}
{{- if and .Values.config.insights.enabled (not .Values.config.deployment.enabled) -}}
{{- fail "config.deployment.enabled must be true when Insights is enabled. Insights requires LangSmith Deployments." -}}
{{- end -}}
{{- if and .Values.config.insights.enabled (not .Values.config.insights.encryptionKey) -}}
{{- fail "config.insights.encryptionKey is required when Insights is enabled. Generate one with: python -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\"" -}}
{{- end -}}

{{- /* Validate autoscaling configuration for all services */ -}}
{{- $autoscalingServices := dict
  "aceBackend" .Values.aceBackend.autoscaling
  "backend" .Values.backend.autoscaling
  "frontend" .Values.frontend.autoscaling
  "hostBackend" .Values.hostBackend.autoscaling
  "listener" .Values.listener.autoscaling
  "platformBackend" .Values.platformBackend.autoscaling
  "playground" .Values.playground.autoscaling
  "queue" .Values.queue.autoscaling
  "ingestQueue" .Values.ingestQueue.autoscaling
-}}
{{- range $serviceName, $autoscaling := $autoscalingServices -}}
{{- /* Validate that both HPA and KEDA are not enabled at the same time */ -}}
{{- if and $autoscaling.hpa.enabled $autoscaling.keda.enabled -}}
{{- fail (printf "Only one of %s.autoscaling.hpa.enabled or %s.autoscaling.keda.enabled can be enabled at the same time." $serviceName $serviceName) -}}
{{- end -}}
{{- /* Validate deprecated autoscaling values */ -}}
{{- if hasKey $autoscaling "createHpa" -}}
{{- fail (printf "%s.autoscaling.createHpa is deprecated. Please use %s.autoscaling.hpa.enabled and/or %s.autoscaling.keda.enabled instead." $serviceName $serviceName $serviceName) -}}
{{- end -}}
{{- if hasKey $autoscaling "type" -}}
{{- fail (printf "%s.autoscaling.type is deprecated. Please use %s.autoscaling.hpa.enabled and/or %s.autoscaling.keda.enabled instead." $serviceName $serviceName $serviceName) -}}
{{- end -}}
{{- if hasKey $autoscaling "enabled" -}}
{{- fail (printf "%s.autoscaling.enabled is deprecated. Please use %s.autoscaling.hpa.enabled and/or %s.autoscaling.keda.enabled instead." $serviceName $serviceName $serviceName) -}}
{{- end -}}
{{- end -}}
